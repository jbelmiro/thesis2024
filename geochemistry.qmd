---
title: "geochemistry"

execute:
  echo: false
  warning: false
  message: false
  comment: "#>"
  fig-path: "../figures/"
  fig-dpi: 600
---

```{r}
#| label: libraries

library(readr)
library(dplyr)
library(janitor)
library(tidyr)
library(gt)
library(ggplot2)

```

# X-ray diffraction (XRD)

# Scanning electron microscopy and energy dispersive X-ray spectroscopy (SEM-EDS)

# Portable X-ray fluorescence (pXRF)

```{r}
#| label: database-read

pxrf_raw <- read_csv('data/pxrf_data_dec.csv')

```

```{r}
#| label: database-setup

pxrf_analysis <- pxrf_raw |> 
  select("Sample_ID", "pXRF_ID", "Formation/Type",
         "MgO", "Al2O3", "SiO2", "P2O5", "S", "Cl", "K2O", "CaO", "TiO2", "Fe2O3", "Cu",
         "Sr", "Zr") |>  # Removed elements with 0 or <LOD values in all samples or in high percentages in all groups
  mutate(`Formation/Type` = case_when(
    `Formation/Type` == "TYPE 1" ~ "T1",
    `Formation/Type` == "TYPE 2" | `Formation/Type` == "TYPE 2B" | `Formation/Type` == "TYPE 2R" ~ "T2",
    `Formation/Type` == "TYPE 3" ~ "T3",
    `Formation/Type` == "TYPE 4" ~ "T4",
    `Formation/Type` == "TYPE 5" ~ "T5",
    `Formation/Type` == "TYPE 6" | `Formation/Type` == "TYPE 6LLB" | `Formation/Type` == "TYPE 6E" ~ "T6",
    `Formation/Type` == "TYPE 7" ~ "T7",
    `Formation/Type` == "TYPE 8" ~ "T8",
    `Formation/Type` == "TYPE 9" ~ "T9",
    `Formation/Type` == "TYPE 10" ~ "T10",
    `Formation/Type` == "TYPE 11" ~ "T11",
    TRUE ~ `Formation/Type`
  ))
  
```

```{r}
#| label: tbl-occurrences
#| tbl-cap: A table.
#| include: false

# Table to see the occurrence of 0 or <LOD values within each element and by rm type, to choose the elements in which to apply statistics.
# Combine the multiple columns into a single table
combined_table <- pxrf_raw |>
  select("Sample_ID", "pXRF_ID", "Formation/Type",
         "MgO", "Al2O3", "SiO2", "P2O5", "S", "Cl", "K2O", "CaO", "TiO2", "V", "MnO", "Fe2O3", "Cu", "As", "Rb",
         "Sr", "Y", "Zr", "Mo", "Ag", "Ba", "Ce", "W", "Au", "Pb") |> 
  mutate(across(
    .cols = c("MgO", "Al2O3", "SiO2", "P2O5", "S", "Cl", "K2O", "CaO", "TiO2", "V", "MnO", "Fe2O3", "Cu", "As", "Rb",
         "Sr", "Y", "Zr", "Mo", "Ag", "Ba", "Ce", "W", "Au", "Pb"),
    .fns = ~ case_when(
      . == 0 | . == "< LOD" ~ "No",
      . > 0 ~ "Yes",
      TRUE ~ as.character(.))
    )) |> 
  mutate(`Chert type` = case_when(
    `Formation/Type` == "TYPE 2B" | `Formation/Type` == "TYPE 2R" ~ "TYPE 2",
    `Formation/Type` == "TYPE 6LLB" | `Formation/Type` == "TYPE 6E" ~ "TYPE 6",
    TRUE ~ `Formation/Type`))

tbl_MgO <- combined_table |> 
  tabyl(`Chert type`, MgO) |>
  adorn_percentages("row") |> 
  adorn_pct_formatting(digits = 1) |> 
  select("Chert type", Yes) |> 
  rename(MgO = Yes)
# Al2O3
tbl_Al2O3 <- combined_table |> 
  tabyl(`Chert type`, Al2O3) |>
  adorn_percentages("row") |>                   
  adorn_pct_formatting(digits = 1) |>
  select("Chert type", Yes) |> 
  rename(Al2O3 = Yes)
# SiO2
tbl_SiO2 <- combined_table |> 
  tabyl(`Chert type`, SiO2) |>
  adorn_percentages("row") |>                   
  adorn_pct_formatting(digits = 1) |>
  select("Chert type", Yes) |> 
  rename(SiO2 = Yes)
# P2O5
tbl_P2O5 <- combined_table |> 
  tabyl(`Chert type`, P2O5) |>
  adorn_percentages("row") |>                   
  adorn_pct_formatting(digits = 1) |>

  select("Chert type", Yes) |> 
  rename(P2O5 = Yes)
# S
tbl_S <- combined_table |> 
  tabyl(`Chert type`, S) |>
  adorn_percentages("row") |>                   
  adorn_pct_formatting(digits = 1) |>

  select("Chert type", Yes) |> 
  rename(S = Yes)
# Cl
tbl_Cl <- combined_table |> 
  tabyl(`Chert type`, Cl) |>
  adorn_percentages("row") |>                   
  adorn_pct_formatting(digits = 1) |>

  select("Chert type", Yes) |> 
  rename(Cl = Yes)
# K2O has 100% rate
tbl_K2O <- combined_table |> 
  tabyl(`Chert type`, K2O) |>
  adorn_percentages("row") |>                   
  adorn_pct_formatting(digits = 1) |>

  select("Chert type", Yes) |> 
  rename(K2O = Yes)
# CaO
tbl_CaO <- combined_table |> 
  tabyl(`Chert type`, CaO) |>
  adorn_percentages("row") |>                   
  adorn_pct_formatting(digits = 1) |>

  select("Chert type", Yes) |> 
  rename(CaO = Yes)
# TiO2
tbl_TiO2 <- combined_table |> 
  tabyl(`Chert type`, TiO2) |>
  adorn_percentages("row") |>                   
  adorn_pct_formatting(digits = 1) |>

  select("Chert type", Yes) |> 
  rename(TiO2 = Yes)
# V
tbl_V <- combined_table |> 
  tabyl(`Chert type`, V) |>
  adorn_percentages("row") |>                   
  adorn_pct_formatting(digits = 1) |>

  select("Chert type", Yes) |> 
  rename(V = Yes)
# MnO
tbl_MnO <- combined_table |> 
  tabyl(`Chert type`, MnO) |>
  adorn_percentages("row") |>                   
  adorn_pct_formatting(digits = 1) |>

  select("Chert type", Yes) |> 
  rename(MnO = Yes)
# Fe2O3 has 100% rate
tbl_Fe2O3 <- combined_table |> 
  tabyl(`Chert type`, Fe2O3) |>
  adorn_percentages("row") |>                   
  adorn_pct_formatting(digits = 1) |>

  select("Chert type", Yes) |> 
  rename(Fe2O3 = Yes)
# Cu
tbl_Cu <- combined_table |> 
  tabyl(`Chert type`, Cu) |>
  adorn_percentages("row") |>                   
  adorn_pct_formatting(digits = 1) |>

  select("Chert type", Yes) |> 
  rename(Cu = Yes)
# As
tbl_As <- combined_table |> 
  tabyl(`Chert type`, As) |>
  adorn_percentages("row") |>                   
  adorn_pct_formatting(digits = 1) |>

  select("Chert type", Yes) |> 
  rename(As = Yes)
# Rb
tbl_Rb <- combined_table |> 
  tabyl(`Chert type`, Rb) |>
  adorn_percentages("row") |>                   
  adorn_pct_formatting(digits = 1) |>

  select("Chert type", Yes) |> 
  rename(Rb = Yes)
# Sr
tbl_Sr <- combined_table |> 
  tabyl(`Chert type`, Sr) |>
  adorn_percentages("row") |>                   
  adorn_pct_formatting(digits = 1) |>

  select("Chert type", Yes) |> 
  rename(Sr = Yes)
# Y
tbl_Y <- combined_table |> 
  tabyl(`Chert type`, Y) |>
  adorn_percentages("row") |>                   
  adorn_pct_formatting(digits = 1) |>

  select("Chert type", Yes) |> 
  rename(Y = Yes)
# Zr
tbl_Zr <- combined_table |> 
  tabyl(`Chert type`, Zr) |>
  adorn_percentages("row") |>                   
  adorn_pct_formatting(digits = 1) |>

  select("Chert type", Yes) |> 
  rename(Zr = Yes)
# Mo
tbl_Mo <- combined_table |> 
  tabyl(`Chert type`, Mo) |>
  adorn_percentages("row") |>                   
  adorn_pct_formatting(digits = 1) |>

  select("Chert type", Yes) |> 
  rename(Mo = Yes)
# Ag
tbl_Ag <- combined_table |> 
  tabyl(`Chert type`, Ag) |>
  adorn_percentages("row") |>                   
  adorn_pct_formatting(digits = 1) |>

  select("Chert type", Yes) |> 
  rename(Ag = Yes)
# Ba
tbl_Ba <- combined_table |> 
  tabyl(`Chert type`, Ba) |>
  adorn_percentages("row") |>                   
  adorn_pct_formatting(digits = 1) |>

  select("Chert type", Yes) |> 
  rename(Ba = Yes)
# Ce
tbl_Ce <- combined_table |> 
  tabyl(`Chert type`, Ce) |>
  adorn_percentages("row") |>                   
  adorn_pct_formatting(digits = 1) |>

  select("Chert type", Yes) |> 
  rename(Ce = Yes)
# W
tbl_W <- combined_table |> 
  tabyl(`Chert type`, W) |>
  adorn_percentages("row") |>                   
  adorn_pct_formatting(digits = 1) |>

  select("Chert type", Yes) |> 
  rename(W = Yes)
# Au
tbl_Au <- combined_table |> 
  tabyl(`Chert type`, Au) |>
  adorn_percentages("row") |>                   
  adorn_pct_formatting(digits = 1) |>

  select("Chert type", Yes) |> 
  rename(Au = Yes)
# Pb
tbl_Pb <- combined_table |> 
  tabyl(`Chert type`, Pb) |>
  adorn_percentages("row") |>                   
  adorn_pct_formatting(digits = 1) |>
  select("Chert type", Yes) |> 
  rename(Pb = Yes)

combined_tbl <- tbl_MgO |> 
  full_join(tbl_Al2O3, by = "Chert type") |> 
  full_join(tbl_SiO2, by = "Chert type") |>
  full_join(tbl_P2O5, by = "Chert type") |> 
  full_join(tbl_S, by = "Chert type") |> 
  full_join(tbl_Cl, by = "Chert type") |> 
  full_join(tbl_K2O, by = "Chert type") |> 
  full_join(tbl_CaO, by = "Chert type") |> 
  full_join(tbl_TiO2, by = "Chert type") |> 
  full_join(tbl_V, by = "Chert type") |> 
  full_join(tbl_MnO, by = "Chert type") |> 
  full_join(tbl_Fe2O3, by = "Chert type") |> 
  full_join(tbl_Cu, by = "Chert type") |> 
  full_join(tbl_As, by = "Chert type") |> 
  full_join(tbl_Rb, by = "Chert type") |> 
  full_join(tbl_Sr, by = "Chert type") |> 
  full_join(tbl_Y, by = "Chert type") |> 
  full_join(tbl_Zr, by = "Chert type") |> 
  full_join(tbl_Mo, by = "Chert type") |> 
  full_join(tbl_Ag, by = "Chert type") |> 
  full_join(tbl_Ba, by = "Chert type") |> 
  full_join(tbl_Ce, by = "Chert type") |> 
  full_join(tbl_W, by = "Chert type") |> 
  full_join(tbl_Au, by = "Chert type") |> 
  full_join(tbl_Pb, by = "Chert type")

combined_tbl[, 2:26] <- lapply(combined_tbl[, 2:26], function(x) as.numeric(sub("%", "", x)))
gt(combined_tbl) %>%
  data_color(
    columns = vars("MgO", "Al2O3", "SiO2", "P2O5", "S", "Cl", "K2O", "CaO", "TiO2", "V", "MnO", "Fe2O3", "Cu", "As", "Rb",
         "Sr", "Y", "Zr", "Mo", "Ag", "Ba", "Ce", "W", "Au", "Pb"),  # Multiple columns
    colors = scales::col_numeric(
      palette = c("#f8f0fc", "#dab6fc", "#b6f7c1"), # Gradient from red to green
      domain = c(0, 100))
  )

```

```{r}
#| label: averages

pxrf_average <- pxrf_analysis |> 
  select(-Sample_ID, -pXRF_ID) |> 
  mutate(across(-`Formation/Type`, ~ as.numeric(.))) |>    # Convert valid numbers
  mutate(across(where(is.numeric), ~ ifelse(is.na(.), 0, .))) |>  # Replace NAs with 0
  group_by(`Formation/Type`) |> 
  summarise(across(where(is.numeric), ~ round(mean(.), 3)))
  pivot_wider(names_from = `Formation/Type`,
              values_from = c("MgO", "Al2O3", "SiO2", "P2O5", "S", "Cl", "K2O", "CaO", "TiO2", "Fe2O3", "Cu",
         "Sr", "Zr"))

average_MgO <- pxrf_average |> 
  ggplot(aes(x = `Formation/Type`, y = MgO)) +
  geom_bar(stat = "identity") +
  theme_minimal() + 
  labs(x = " ",y = "MgO")

average_Al2O3 <- pxrf_average |> 
  ggplot(aes(x = `Formation/Type`, y = Al2O3)) +
  geom_bar(stat = "identity") +
  theme_minimal() + 
  labs(x = " ",y = "Al2O3")

average_SiO2 <- pxrf_average |> 
  ggplot(aes(x = `Formation/Type`, y = SiO2)) +
  geom_bar(stat = "identity") +
  theme_minimal() + 
  labs(x = " ",y = "SiO2")

average_P2O5 <- pxrf_average |> 
  ggplot(aes(x = `Formation/Type`, y = P2O5)) +
  geom_bar(stat = "identity") +
  theme_minimal() + 
  labs(x = " ",y = "P2O5")

average_S <- pxrf_average |> 
  ggplot(aes(x = `Formation/Type`, y = S)) +
  geom_bar(stat = "identity") +
  theme_minimal() + 
  labs(x = " ",y = "S")

average_Cl <- pxrf_average |> 
  ggplot(aes(x = `Formation/Type`, y = Cl)) +
  geom_bar(stat = "identity") +
  theme_minimal() + 
  labs(x = " ",y = "Cl")

average_K2O <- pxrf_average |> 
  ggplot(aes(x = `Formation/Type`, y = K2O)) +
  geom_bar(stat = "identity") +
  theme_minimal() + 
  labs(x = " ",y = "K2O")

average_CaO <- pxrf_average |> 
  ggplot(aes(x = `Formation/Type`, y = CaO)) +
  geom_bar(stat = "identity") +
  theme_minimal() + 
  labs(x = " ",y = "CaO")

average_TiO2 <- pxrf_average |> 
  ggplot(aes(x = `Formation/Type`, y = TiO2)) +
  geom_bar(stat = "identity") +
  theme_minimal() + 
  labs(x = " ",y = "TiO2")

average_Fe2O3 <- pxrf_average |> 
  ggplot(aes(x = `Formation/Type`, y = Fe2O3)) +
  geom_bar(stat = "identity") +
  theme_minimal() + 
  labs(x = " ",y = "Fe2O3")

average_Sr <- pxrf_average |> 
  ggplot(aes(x = `Formation/Type`, y = Sr)) +
  geom_bar(stat = "identity") +
  theme_minimal() + 
  labs(x = " ",y = "Sr")

```


## Methodology

For this experiment, a Bruker portable XRF Titan S1 was used in a laboratory benchtop setup, using battery power (up to 25% battery charge then replaced by a fully charged battery). A validation run was applied on two standard samples provided by Bruker and using the standard calibration. Samples were scanned for 180 seconds each (90 seconds for the first phase for major elements and 90 seconds for the second phase for minor elements), at least once, with several scans applied to samples that showed macroscopic variability (e.g., areas with different colours or translucency). The standard database from Bruker was used, with the Geochem application and Dual Mining method. \*\* chert samples were scanned, from several sources and chert types, both geological and archaeological. After scanning, the scanned face was measured (thickness and diameter), to guarantee a minimum thickness and size was followed for each sample, since other studies have shown thickness and size may impact the homogeneity of data collection and results [@newlanderEmpiricalStudyEffect2015]. All samples, including their thickness and diameter, can be found in table X. For geological samples, fresh, flat surfaces were scanned, avoiding altered faces or cortex; whenever necessary, the samples were prepared by breaking the nodules. The samples were chosen to represent all varieties of chert identified in the Algarve region, in the archaeological record of Vale Boi, but also from other regions such as Central Portugal and South Spain, to allow their comparison and test hypotheses made from macroscopic and petrographic data. For archaeological samples, artefacts were chosen from previously identified types (REF?), focusing on larger and flatter morphologies, with the least degree of surface alterations possible.

The analysis and result reporting protocol was established following previous studies, focusing on the accuracy of obtained data but also the transparency and reproducibility of the results [@newlanderEmpiricalStudyEffect2015; @johnsonBestPracticesPublishing2024]. For further reproducibility and replicability, and working towards the goal of open science [@johnsonBestPracticesPublishing2024; @marwickComputationalReproducibilityArchaeological2017], the obtained raw pXRF results can be found online on our online compendium (LINK).

## Results

The pXRF measured several major and minor elements, of which a small amount returned values of 0 or were below the limit of detection (\<LOD). These were uranium (U), thorium (Th), bismuth (Bi), thallium (Tl), mercury (Hg), platinum (Pt), tantalum (Ta), hafnium (Hf), lanthanum (La), antimony (Sb), Tin (Sn), cadmium (Cd), rhodium (Rh), niobium (Nb), selenium (Se), zinc (Zn), nickel (Ni), cobalt (Co) and chromium (Cr). They were removed from the analysis based on their nonexistence, although they can still be found in the raw pXRF results.
